import { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { Button } from "@/components/ui/button";
import { Card } from "@/components/ui/card";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import { Checkbox } from "@/components/ui/checkbox";
import { useAuthStore } from "@/stores/authStore";
import { toast } from "sonner";
import ProgressBar from "@/components/ProgressBar";
import { Warehouse, MapPin, Gauge, Wrench, Camera, FileText, DollarSign, CheckCircle, Upload } from "lucide-react";

const ETAPAS = [
  "Tipo de Silo",
  "Localiza√ß√£o",
  "Capacidade",
  "Infraestrutura",
  "Fotos",
  "Pre√ßo e Descri√ß√£o",
  "Documentos",
  "Revis√£o Final",
  "Confirma√ß√£o"
];

const TIPOS_SILO = [
  { id: "metalico", nome: "Silo Met√°lico", descricao: "Estrutura met√°lica para gr√£os", icon: "üè≠" },
  { id: "graneleiro", nome: "Armaz√©m Graneleiro", descricao: "Armaz√©m convencional", icon: "üè¢" },
  { id: "bolsa", nome: "Silo Bolsa", descricao: "Armazenagem tempor√°ria", icon: "üì¶" },
  { id: "outro", nome: "Outro", descricao: "Outro tipo de estrutura", icon: "‚ûï" }
];

const INFRAESTRUTURA_OPTIONS = [
  { id: "secagem", label: "Secagem Completa", icon: "üî•" },
  { id: "limpeza", label: "Limpeza de Gr√£os", icon: "‚ú®" },
  { id: "aeracao", label: "Aera√ß√£o Controlada", icon: "üí®" },
  { id: "monitoramento", label: "Monitoramento 24/7", icon: "üì°" },
  { id: "balanca", label: "Balan√ßa Rodovi√°ria", icon: "‚öñÔ∏è" },
  { id: "laboratorio", label: "Laborat√≥rio de An√°lise", icon: "üî¨" }
];

const TIPOS_DOCUMENTOS = [
  "Matr√≠cula do Im√≥vel",
  "CNPJ ou CPF",
  "Laudo de Vistoria",
  "Certificado CONAB",
  "Licen√ßa Ambiental",
  "Alvar√° de Funcionamento"
];

export default function CadastrarSilo_v2() {
  const [, setLocation] = useLocation();
  const { usuario, isAuthenticated, isLoading: loading } = useAuthStore();
  const [etapaAtual, setEtapaAtual] = useState(1);
  const [salvandoAutomatico, setSalvandoAutomatico] = useState(false);

  const [dados, setDados] = useState({
    // Etapa 1: Tipo
    tipoSilo: "",
    
    // Etapa 2: Localiza√ß√£o
    endereco: "",
    cidade: "",
    estado: "",
    cep: "",
    latitude: "",
    longitude: "",
    
    // Etapa 3: Capacidade
    capacidadeTotal: "",
    capacidadeDisponivel: "",
    unidade: "toneladas",
    
    // Etapa 4: Infraestrutura
    infraestrutura: [] as string[],
    
    // Etapa 5: Fotos
    fotos: [] as string[],
    
    // Etapa 6: Pre√ßo e Descri√ß√£o
    precoPorTonelada: "",
    precoPorMes: "",
    descricao: "",
    
    // Etapa 7: Documentos
    documentos: {} as Record<string, boolean>,
    
    // Etapa 8: Revis√£o (n√£o precisa de campos)
  });

  // Auto-save a cada 30 segundos
  useEffect(() => {
    if (!isAuthenticated) return;
    
    const interval = setInterval(() => {
      salvarRascunho();
    }, 30000);

    return () => clearInterval(interval);
  }, [dados, isAuthenticated]);

  const salvarRascunho = async () => {
    setSalvandoAutomatico(true);
    // Aqui voc√™ faria a chamada para o backend
    // await api.salvarRascunho(dados);
    setTimeout(() => {
      setSalvandoAutomatico(false);
    }, 1000);
  };

  const handleChange = (campo: string, valor: any) => {
    setDados({ ...dados, [campo]: valor });
  };

  const toggleInfraestrutura = (id: string) => {
    const novaInfra = dados.infraestrutura.includes(id)
      ? dados.infraestrutura.filter(i => i !== id)
      : [...dados.infraestrutura, id];
    handleChange("infraestrutura", novaInfra);
  };

  const validarEtapa = () => {
    switch (etapaAtual) {
      case 1:
        if (!dados.tipoSilo) {
          toast.error("Selecione o tipo de silo");
          return false;
        }
        break;
      case 2:
        if (!dados.endereco || !dados.cidade || !dados.estado) {
          toast.error("Preencha todos os campos de localiza√ß√£o");
          return false;
        }
        break;
      case 3:
        if (!dados.capacidadeTotal || !dados.capacidadeDisponivel) {
          toast.error("Preencha a capacidade do silo");
          return false;
        }
        break;
      case 6:
        if (!dados.precoPorTonelada && !dados.precoPorMes) {
          toast.error("Informe pelo menos um tipo de pre√ßo");
          return false;
        }
        break;
    }
    return true;
  };

  const proximaEtapa = () => {
    if (!validarEtapa()) return;
    
    if (etapaAtual < 9) {
      setEtapaAtual(etapaAtual + 1);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  };

  const etapaAnterior = () => {
    if (etapaAtual > 1) {
      setEtapaAtual(etapaAtual - 1);
      window.scrollTo({ top: 0, behavior: "smooth" });
    }
  };

  const finalizarCadastro = async () => {
    toast.success("Cadastro enviado com sucesso!");
    // Aqui voc√™ faria a chamada para o backend
    // await api.cadastrarSilo(dados);
    setEtapaAtual(9); // Ir para tela de confirma√ß√£o
  };

  if (loading) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <p className="text-lg text-gray-600">Carregando...</p>
      </div>
    );
  }

  if (!isAuthenticated) {
    return (
      <div className="min-h-screen bg-white">
        <header className="border-b bg-white sticky top-0 z-50">
          <div className="container mx-auto px-4 py-4 flex items-center justify-between">
            <div className="flex items-center gap-2 cursor-pointer" onClick={() => setLocation("/")}>
              <span className="text-3xl">üåæ</span>
              <span className="text-2xl font-bold text-black">SiloShare</span>
            </div>
            <Button onClick={() => setLocation("/")} variant="outline">
              Voltar
            </Button>
          </div>
        </header>
        <div className="container mx-auto px-4 py-12 text-center">
          <h1 className="text-3xl font-bold mb-4">Acesso Restrito</h1>
          <p className="text-gray-600 mb-8">Voc√™ precisa estar logado para cadastrar um silo.</p>
          <Button onClick={() => setLocation("/login")} className="bg-black hover:bg-gray-800">
            Fazer Login
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <header className="bg-white border-b sticky top-0 z-50">
        <div className="container mx-auto px-4 py-4 flex items-center justify-between">
          <div className="flex items-center gap-2 cursor-pointer" onClick={() => setLocation("/")}>
            <span className="text-3xl">üåæ</span>
            <span className="text-2xl font-bold text-black">SiloShare</span>
          </div>
          <div className="flex items-center gap-4">
            {salvandoAutomatico && (
              <span className="text-sm text-gray-500">Salvando...</span>
            )}
            <Button onClick={() => setLocation("/painel-fornecedor")} variant="ghost">
              Salvar e sair
            </Button>
          </div>
        </div>
      </header>

      {/* Progress Bar */}
      <ProgressBar 
        currentStep={etapaAtual} 
        totalSteps={9} 
        steps={ETAPAS}
      />

      {/* Conte√∫do */}
      <div className="container mx-auto px-4 py-8 max-w-3xl">
        <Card className="p-8">
          {/* Etapa 1: Tipo de Silo */}
          {etapaAtual === 1 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Que tipo de silo voc√™ oferece?</h2>
                <p className="text-gray-600">Escolha a op√ß√£o que melhor descreve</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {TIPOS_SILO.map((tipo) => (
                  <button
                    key={tipo.id}
                    onClick={() => handleChange("tipoSilo", tipo.id)}
                    className={`
                      p-6 border-2 rounded-lg text-left transition-all
                      ${dados.tipoSilo === tipo.id 
                        ? "border-black bg-gray-50" 
                        : "border-gray-200 hover:border-gray-300"
                      }
                    `}
                  >
                    <div className="text-4xl mb-3">{tipo.icon}</div>
                    <h3 className="font-semibold text-lg mb-1">{tipo.nome}</h3>
                    <p className="text-sm text-gray-600">{tipo.descricao}</p>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Etapa 2: Localiza√ß√£o */}
          {etapaAtual === 2 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Onde est√° localizado o silo?</h2>
                <p className="text-gray-600">Informe o endere√ßo completo</p>
              </div>

              <div className="space-y-4">
                <div>
                  <Label htmlFor="endereco">Endere√ßo Completo</Label>
                  <Input
                    id="endereco"
                    value={dados.endereco}
                    onChange={(e) => handleChange("endereco", e.target.value)}
                    placeholder="Rua, n√∫mero, bairro"
                  />
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="cidade">Cidade</Label>
                    <Input
                      id="cidade"
                      value={dados.cidade}
                      onChange={(e) => handleChange("cidade", e.target.value)}
                      placeholder="Ex: Primavera do Leste"
                    />
                  </div>

                  <div>
                    <Label htmlFor="estado">Estado</Label>
                    <Input
                      id="estado"
                      value={dados.estado}
                      onChange={(e) => handleChange("estado", e.target.value)}
                      placeholder="Ex: MT"
                      maxLength={2}
                    />
                  </div>
                </div>

                <div>
                  <Label htmlFor="cep">CEP</Label>
                  <Input
                    id="cep"
                    value={dados.cep}
                    onChange={(e) => handleChange("cep", e.target.value)}
                    placeholder="00000-000"
                  />
                </div>

                <div className="bg-gray-100 p-4 rounded-lg">
                  <p className="text-sm text-gray-600 mb-2">
                    üí° Dica: Um mapa interativo ser√° adicionado aqui para voc√™ marcar a localiza√ß√£o exata
                  </p>
                </div>
              </div>
            </div>
          )}

          {/* Etapa 3: Capacidade */}
          {etapaAtual === 3 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Qual a capacidade do silo?</h2>
                <p className="text-gray-600">Informe a capacidade total e dispon√≠vel</p>
              </div>

              <div className="space-y-4">
                <div>
                  <Label htmlFor="capacidadeTotal">Capacidade Total (toneladas)</Label>
                  <Input
                    id="capacidadeTotal"
                    type="number"
                    value={dados.capacidadeTotal}
                    onChange={(e) => handleChange("capacidadeTotal", e.target.value)}
                    placeholder="Ex: 5000"
                  />
                </div>

                <div>
                  <Label htmlFor="capacidadeDisponivel">Capacidade Dispon√≠vel (toneladas)</Label>
                  <Input
                    id="capacidadeDisponivel"
                    type="number"
                    value={dados.capacidadeDisponivel}
                    onChange={(e) => handleChange("capacidadeDisponivel", e.target.value)}
                    placeholder="Ex: 3000"
                  />
                </div>

                {dados.capacidadeTotal && dados.capacidadeDisponivel && (
                  <div className="bg-green-50 border border-green-200 p-4 rounded-lg">
                    <p className="text-sm text-green-800">
                      ‚úì {((Number(dados.capacidadeDisponivel) / Number(dados.capacidadeTotal)) * 100).toFixed(0)}% da capacidade dispon√≠vel
                    </p>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* Etapa 4: Infraestrutura */}
          {etapaAtual === 4 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Qual infraestrutura dispon√≠vel?</h2>
                <p className="text-gray-600">Selecione todos os servi√ßos oferecidos</p>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {INFRAESTRUTURA_OPTIONS.map((infra) => (
                  <button
                    key={infra.id}
                    onClick={() => toggleInfraestrutura(infra.id)}
                    className={`
                      p-4 border-2 rounded-lg text-left transition-all flex items-center gap-3
                      ${dados.infraestrutura.includes(infra.id)
                        ? "border-black bg-gray-50"
                        : "border-gray-200 hover:border-gray-300"
                      }
                    `}
                  >
                    <span className="text-2xl">{infra.icon}</span>
                    <span className="font-medium">{infra.label}</span>
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Etapa 5: Fotos */}
          {etapaAtual === 5 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Adicione fotos do silo</h2>
                <p className="text-gray-600">Fotos de qualidade atraem mais clientes</p>
              </div>

              <div className="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center">
                <Camera className="w-12 h-12 mx-auto mb-4 text-gray-400" />
                <p className="text-gray-600 mb-4">Arraste fotos ou clique para selecionar</p>
                <Button variant="outline">
                  <Upload className="w-4 h-4 mr-2" />
                  Selecionar Fotos
                </Button>
                <p className="text-sm text-gray-500 mt-4">
                  M√≠nimo 3 fotos, m√°ximo 10 fotos (JPG ou PNG, at√© 5MB cada)
                </p>
              </div>
            </div>
          )}

          {/* Etapa 6: Pre√ßo e Descri√ß√£o */}
          {etapaAtual === 6 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Pre√ßo e Descri√ß√£o</h2>
                <p className="text-gray-600">Defina seus pre√ßos e descreva seu silo</p>
              </div>

              <div className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="precoPorTonelada">Pre√ßo por Tonelada/M√™s (R$)</Label>
                    <Input
                      id="precoPorTonelada"
                      type="number"
                      value={dados.precoPorTonelada}
                      onChange={(e) => handleChange("precoPorTonelada", e.target.value)}
                      placeholder="Ex: 25.00"
                    />
                  </div>

                  <div>
                    <Label htmlFor="precoPorMes">Pre√ßo Fixo Mensal (R$)</Label>
                    <Input
                      id="precoPorMes"
                      type="number"
                      value={dados.precoPorMes}
                      onChange={(e) => handleChange("precoPorMes", e.target.value)}
                      placeholder="Ex: 50000.00"
                    />
                  </div>
                </div>

                <div>
                  <Label htmlFor="descricao">Descri√ß√£o do Silo</Label>
                  <Textarea
                    id="descricao"
                    value={dados.descricao}
                    onChange={(e) => handleChange("descricao", e.target.value)}
                    placeholder="Descreva as caracter√≠sticas, localiza√ß√£o, acesso, etc."
                    rows={6}
                  />
                </div>
              </div>
            </div>
          )}

          {/* Etapa 7: Documentos */}
          {etapaAtual === 7 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Documentos Necess√°rios</h2>
                <p className="text-gray-600">Fa√ßa upload dos documentos obrigat√≥rios</p>
              </div>

              <div className="space-y-3">
                {TIPOS_DOCUMENTOS.map((doc) => (
                  <div key={doc} className="border rounded-lg p-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                      <FileText className="w-5 h-5 text-gray-400" />
                      <span className="font-medium">{doc}</span>
                    </div>
                    <Button variant="outline" size="sm">
                      <Upload className="w-4 h-4 mr-2" />
                      Upload
                    </Button>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Etapa 8: Revis√£o Final */}
          {etapaAtual === 8 && (
            <div className="space-y-6">
              <div>
                <h2 className="text-2xl font-bold mb-2">Revise seu an√∫ncio</h2>
                <p className="text-gray-600">Confira se est√° tudo certo antes de enviar</p>
              </div>

              <div className="space-y-4">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <h3 className="font-semibold mb-2">Tipo de Silo</h3>
                  <p className="text-gray-700">{TIPOS_SILO.find(t => t.id === dados.tipoSilo)?.nome}</p>
                </div>

                <div className="bg-gray-50 p-4 rounded-lg">
                  <h3 className="font-semibold mb-2">Localiza√ß√£o</h3>
                  <p className="text-gray-700">{dados.endereco}, {dados.cidade} - {dados.estado}</p>
                </div>

                <div className="bg-gray-50 p-4 rounded-lg">
                  <h3 className="font-semibold mb-2">Capacidade</h3>
                  <p className="text-gray-700">Total: {dados.capacidadeTotal} ton | Dispon√≠vel: {dados.capacidadeDisponivel} ton</p>
                </div>

                <div className="bg-gray-50 p-4 rounded-lg">
                  <h3 className="font-semibold mb-2">Infraestrutura</h3>
                  <p className="text-gray-700">{dados.infraestrutura.length} servi√ßos selecionados</p>
                </div>

                <div className="bg-gray-50 p-4 rounded-lg">
                  <h3 className="font-semibold mb-2">Pre√ßo</h3>
                  <p className="text-gray-700">
                    {dados.precoPorTonelada && `R$ ${dados.precoPorTonelada}/ton/m√™s`}
                    {dados.precoPorMes && ` | R$ ${dados.precoPorMes}/m√™s`}
                  </p>
                </div>
              </div>

              <div className="bg-yellow-50 border border-yellow-200 p-4 rounded-lg">
                <p className="text-sm text-yellow-800">
                  ‚ö†Ô∏è Seu an√∫ncio entrar√° em an√°lise pela nossa equipe. Voc√™ receber√° uma resposta por e-mail em at√© 48 horas.
                </p>
              </div>
            </div>
          )}

          {/* Etapa 9: Confirma√ß√£o */}
          {etapaAtual === 9 && (
            <div className="space-y-6 text-center py-8">
              <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                <CheckCircle className="w-12 h-12 text-green-600" />
              </div>

              <div>
                <h2 className="text-3xl font-bold mb-2">Cadastro Enviado com Sucesso!</h2>
                <p className="text-gray-600">
                  Seu silo entrar√° em an√°lise pela nossa equipe.
                </p>
              </div>

              <div className="bg-gray-50 p-6 rounded-lg text-left max-w-md mx-auto">
                <h3 className="font-semibold mb-3">Pr√≥ximos Passos:</h3>
                <ul className="space-y-2 text-sm text-gray-700">
                  <li>‚úì An√°lise da documenta√ß√£o (at√© 24h)</li>
                  <li>‚úì Verifica√ß√£o das informa√ß√µes (at√© 48h)</li>
                  <li>‚úì Aprova√ß√£o e publica√ß√£o do an√∫ncio</li>
                  <li>‚úì Voc√™ receber√° um e-mail com o resultado</li>
                </ul>
              </div>

              <div className="flex gap-4 justify-center">
                <Button onClick={() => setLocation("/")} variant="outline">
                  Voltar para Home
                </Button>
                <Button onClick={() => setLocation("/painel-fornecedor")} className="bg-black hover:bg-gray-800">
                  Ir para Meu Painel
                </Button>
              </div>
            </div>
          )}

          {/* Bot√µes de Navega√ß√£o */}
          {etapaAtual < 9 && (
            <div className="flex justify-between mt-8 pt-6 border-t">
              <Button
                onClick={etapaAnterior}
                variant="outline"
                disabled={etapaAtual === 1}
              >
                Voltar
              </Button>

              {etapaAtual < 8 ? (
                <Button onClick={proximaEtapa} className="bg-black hover:bg-gray-800">
                  Continuar
                </Button>
              ) : (
                <Button onClick={finalizarCadastro} className="bg-green-600 hover:bg-green-700">
                  Enviar para An√°lise
                </Button>
              )}
            </div>
          )}
        </Card>
      </div>
    </div>
  );
}

