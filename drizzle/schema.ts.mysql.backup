import {
  boolean,
  datetime,
  decimal,
  int,
  mysqlEnum,
  mysqlTable,
  text,
  timestamp,
  varchar,
  json,
} from "drizzle-orm/mysql-core";

/**
 * ========================================
 * TABELA DE USUÁRIOS
 * ========================================
 */
export const users = mysqlTable("users", {
  id: varchar("id", { length: 64 }).primaryKey(),
  name: text("name"),
  email: varchar("email", { length: 320 }),
  password: varchar("password", { length: 255 }), // Hash bcrypt
  telefone: varchar("telefone", { length: 20 }),
  cpfCnpj: varchar("cpfCnpj", { length: 18 }),
  loginMethod: varchar("loginMethod", { length: 64 }),
  role: mysqlEnum("role", ["user", "admin"]).default("user").notNull(),
  tipoUsuario: mysqlEnum("tipoUsuario", ["produtor", "dono_silo", "transportadora"]),
  verificado: boolean("verificado").default(false),
  emailVerificado: boolean("emailVerificado").default(false),
  celularVerificado: boolean("celularVerificado").default(false),
  avaliacaoMedia: decimal("avaliacaoMedia", { precision: 3, scale: 2 }).default("0.00"),
  totalAvaliacoes: int("totalAvaliacoes").default(0),
  createdAt: timestamp("createdAt").defaultNow(),
  lastSignedIn: timestamp("lastSignedIn").defaultNow(),
});

export type User = typeof users.$inferSelect;
export type InsertUser = typeof users.$inferInsert;

/**
 * ========================================
 * TABELA DE CÓDIGOS DE VERIFICAÇÃO
 * ========================================
 */
export const verificationCodes = mysqlTable("verificationCodes", {
  id: int("id").primaryKey().autoincrement(),
  userId: varchar("userId", { length: 64 }).notNull(),
  code: varchar("code", { length: 10 }).notNull(),
  type: mysqlEnum("type", ["email", "sms"]).notNull(),
  expiresAt: timestamp("expiresAt").notNull(),
  used: boolean("used").default(false),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE PRODUTORES
 * ========================================
 */
export const produtores = mysqlTable("produtores", {
  id: int("id").primaryKey().autoincrement(),
  userId: varchar("userId", { length: 64 }).notNull(),
  propriedade: text("propriedade"),
  cidade: varchar("cidade", { length: 100 }),
  estado: varchar("estado", { length: 2 }),
  endereco: text("endereco"),
  tiposGraos: text("tiposGraos"),
  volumeAnual: decimal("volumeAnual", { precision: 10, scale: 2 }),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE SILOS
 * ========================================
 */
export const silos = mysqlTable("silos", {
  id: int("id").primaryKey().autoincrement(),
  userId: varchar("userId", { length: 64 }).notNull(),
  nome: varchar("nome", { length: 200 }).notNull(),
  descricao: text("descricao"),
  tipo: mysqlEnum("tipo", ["metalico", "graneleiro", "bolsa", "outro"]).notNull(),
  cidade: varchar("cidade", { length: 100 }).notNull(),
  estado: varchar("estado", { length: 2 }).notNull(),
  endereco: text("endereco"),
  latitude: decimal("latitude", { precision: 10, scale: 7 }),
  longitude: decimal("longitude", { precision: 10, scale: 7 }),
  capacidadeTotal: decimal("capacidadeTotal", { precision: 10, scale: 2 }).notNull(),
  capacidadeDisponivel: decimal("capacidadeDisponivel", { precision: 10, scale: 2 }),
  precoTonMes: decimal("precoTonMes", { precision: 10, scale: 2 }).notNull(),
  tiposGraosAceitos: text("tiposGraosAceitos"),
  infraestrutura: text("infraestrutura"),
  fotos: text("fotos"),
  certificacoes: text("certificacoes"),
  status: mysqlEnum("status", ["pendente", "aprovado", "reprovado", "inativo"]).default("pendente"),
  motivoReprovacao: text("motivoReprovacao"),
  avaliacaoMedia: decimal("avaliacaoMedia", { precision: 3, scale: 2 }).default("0.00"),
  totalAvaliacoes: int("totalAvaliacoes").default(0),
  visualizacoes: int("visualizacoes").default(0),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow(),
});

export type Silo = typeof silos.$inferSelect;
export type InsertSilo = typeof silos.$inferInsert;

/**
 * ========================================
 * TABELA DE CADASTROS RASCUNHO (AUTO-SAVE)
 * ========================================
 */
export const cadastrosRascunho = mysqlTable("cadastrosRascunho", {
  id: int("id").primaryKey().autoincrement(),
  userId: varchar("userId", { length: 64 }).notNull(),
  tipo: mysqlEnum("tipo", ["silo", "transportadora"]).notNull(),
  dados: json("dados").notNull(),
  etapaAtual: int("etapaAtual").default(1),
  createdAt: timestamp("createdAt").defaultNow(),
  updatedAt: timestamp("updatedAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE DOCUMENTOS DOS SILOS
 * ========================================
 */
export const documentosSilos = mysqlTable("documentosSilos", {
  id: int("id").primaryKey().autoincrement(),
  siloId: int("siloId").notNull(),
  tipoDocumento: varchar("tipoDocumento", { length: 100 }).notNull(),
  nomeArquivo: varchar("nomeArquivo", { length: 255 }).notNull(),
  urlArquivo: text("urlArquivo").notNull(),
  tamanho: int("tamanho"),
  verificado: boolean("verificado").default(false),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE DOCUMENTOS DOS PRODUTORES
 * ========================================
 */
export const documentosProdutores = mysqlTable("documentosProdutores", {
  id: int("id").primaryKey().autoincrement(),
  produtorId: int("produtorId").notNull(),
  tipoDocumento: varchar("tipoDocumento", { length: 100 }).notNull(),
  nomeArquivo: varchar("nomeArquivo", { length: 255 }).notNull(),
  urlArquivo: text("urlArquivo").notNull(),
  tamanho: int("tamanho"),
  verificado: boolean("verificado").default(false),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE TRANSPORTADORAS
 * ========================================
 */
export const transportadoras = mysqlTable("transportadoras", {
  id: int("id").primaryKey().autoincrement(),
  userId: varchar("userId", { length: 64 }).notNull(),
  nomeEmpresa: varchar("nomeEmpresa", { length: 200 }).notNull(),
  cnpj: varchar("cnpj", { length: 18 }),
  cidade: varchar("cidade", { length: 100 }),
  estado: varchar("estado", { length: 2 }),
  endereco: text("endereco"),
  tiposFrota: text("tiposFrota"),
  capacidadeFrota: decimal("capacidadeFrota", { precision: 10, scale: 2 }),
  raioAtuacao: int("raioAtuacao"),
  precoKmTon: decimal("precoKmTon", { precision: 10, scale: 2 }),
  avaliacaoMedia: decimal("avaliacaoMedia", { precision: 3, scale: 2 }).default("0.00"),
  totalAvaliacoes: int("totalAvaliacoes").default(0),
  status: mysqlEnum("status", ["pendente", "aprovado", "reprovado", "inativo"]).default("pendente"),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE RESERVAS
 * ========================================
 */
export const reservas = mysqlTable("reservas", {
  id: int("id").primaryKey().autoincrement(),
  siloId: int("siloId").notNull(),
  produtorId: int("produtorId").notNull(),
  capacidadeReservada: decimal("capacidadeReservada", { precision: 10, scale: 2 }).notNull(),
  dataInicio: datetime("dataInicio").notNull(),
  dataFim: datetime("dataFim").notNull(),
  valorTotal: decimal("valorTotal", { precision: 10, scale: 2 }).notNull(),
  status: mysqlEnum("status", ["pendente", "confirmada", "cancelada", "finalizada"]).default("pendente"),
  pagamentoStatus: mysqlEnum("pagamentoStatus", ["pendente", "pago", "reembolsado"]).default("pendente"),
  contratoUrl: text("contratoUrl"),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE COTAÇÕES DE TRANSPORTE
 * ========================================
 */
export const cotacoesTransporte = mysqlTable("cotacoesTransporte", {
  id: int("id").primaryKey().autoincrement(),
  reservaId: int("reservaId").notNull(),
  transportadoraId: int("transportadoraId").notNull(),
  origem: text("origem").notNull(),
  destino: text("destino").notNull(),
  distanciaKm: decimal("distanciaKm", { precision: 10, scale: 2 }),
  valorCotado: decimal("valorCotado", { precision: 10, scale: 2 }).notNull(),
  prazoEntrega: int("prazoEntrega"),
  status: mysqlEnum("status", ["pendente", "aceita", "recusada"]).default("pendente"),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE AVALIAÇÕES
 * ========================================
 */
export const avaliacoes = mysqlTable("avaliacoes", {
  id: int("id").primaryKey().autoincrement(),
  autorId: varchar("autorId", { length: 64 }).notNull(),
  avaliadoId: varchar("avaliadoId", { length: 64 }).notNull(),
  tipoAvaliado: mysqlEnum("tipoAvaliado", ["silo", "produtor", "transportadora"]).notNull(),
  nota: int("nota").notNull(),
  comentario: text("comentario"),
  reservaId: int("reservaId"),
  createdAt: timestamp("createdAt").defaultNow(),
});

/**
 * ========================================
 * TABELA DE MENSAGENS
 * ========================================
 */
export const mensagens = mysqlTable("mensagens", {
  id: int("id").primaryKey().autoincrement(),
  remetenteId: varchar("remetenteId", { length: 64 }).notNull(),
  destinatarioId: varchar("destinatarioId", { length: 64 }).notNull(),
  assunto: varchar("assunto", { length: 200 }),
  mensagem: text("mensagem").notNull(),
  lida: boolean("lida").default(false),
  createdAt: timestamp("createdAt").defaultNow(),
});

